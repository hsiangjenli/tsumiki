---
mode: agent
description: 依照 SDD 契約設計模板，將 BDD 案例轉為具體介面與資料契約，並安排後續合約測試
inputs:
  summary: 需先取得 BDD Issue 與相關設計資料，確認要涵蓋的情境
  required:
    - 目標 BDD Issue 連結與 Scenario 摘要
    - 現有或需延用的契約文件（OpenAPI、Schema、模型說明等）
    - 涉及的子系統與資料流限制
    - Mock / 測試環境需求
    - 語言與輸出格式偏好（預設繁體中文 + Markdown）
outputs:
  summary: 產出符合 `.github/ISSUE_TEMPLATE/sdd.md` 的內容，並排定合約測試與 mock 待辦
  include:
    - 對每個 Gherkin 情境（以 `BDD-###` 標識）對應的契約類型、名稱、關鍵欄位與驗證方式（引用資料附 `#編號`，對待確認項目標註 🟡／🔴）
    - Mock／樣本資料策略與預期失敗案例
    - 版本與部署策略（版號、相容性、切換、監控、回滾負責人）及需同步的文件/Issue
    - 對應的 TDD Issue 建議與開放問題（使用 `#編號`，若待建立需提供建議標題）
    - 提醒使用者透過 MCP 建立 SDD Issue、更新契約檔案位置並回填到對應的 BDD Issue（Scenario 對照表）
    - 明確給出 Issue `title`，格式固定為 `[SDD] 模組／契約名稱 - 簡述`
---

# sdd

## 目的

根據既有 BDD 案例，萃取所有需要更新或新增的介面、資料、模型與流程契約，確保後續實作有明確的合約測試與 mock 依據。

## 前置條件

- 已有 BDD Issue（或草稿）可參考。
- 確認需求未進一步變動，若有變動需先回到 BDD 更新。
- 可存取相關設計文件、既有契約或資料字典。

## 問答原則

- 每題提供最多 4 個選項，加上「⑤ 其他（自由輸入）」。
- 若情境跨多個子系統，分別詢問各子系統的需求與限制。
- 針對資料或模型契約，要確認來源、版控方式與隱私限制。

## 流程

### Step 1：同步情境
1. 根據 BDD 輸出收集 Scenario ID（`BDD-###`）、需求 `#編號` 與主要行為摘要。
2. 檢查是否已有可沿用的契約（OpenAPI、AsyncAPI、Schema、模型版本等），並標註狀態（🔵／🟡／🔴）。
3. 確認此次涵蓋的子系統：API、事件流、資料表、模型、UI、排程、監控等。

### Step 2：萃取契約
1. 對每個 Scenario 詢問輸入／輸出欄位、驗證規則、錯誤回應與必要的前置條件。
2. 若情境涉及資料或模型，確認資料來源、轉換規則、版本策略與存放位置。
3. 若情境包含 UI／狀態，描述需要維持的一致性與可及性需求。
4. 蒐集 Mock／樣本資料需求與建立方式（僅記錄概要，詳細檔名或腳本留給 TDD）。
5. 記錄部署與相容性要點：版號格式、向後相容、切換與回滾流程、受影響服務。

### Step 3：整理輸出
1. **契約對照表**：`Scenario ID | 契約類型 | 契約名稱/路徑 | 關鍵欄位或事件 | 驗證方式 | 來源 # | 狀態`，對待確認欄位標註 🟡／🔴。
2. **Mock / 樣本策略**：列出資料來源、建立方式、負責人與預計完成時間。
3. **版本與部署摘要**：敘明版號策略（SemVer 或日期）、相容性判斷、切換與監控需求、回滾責任人。
4. **交付清單**：整理需建立的 TDD Issue、需更新的文件、相關 PR／監控設定，使用 `項目 | 描述 | 來源 # | 負責人 | 截止日期 | 狀態` 欄位。
5. **開放問題**：列出尚待確認的欄位、資料來源或限制，附責任人與預計解法。
6. **Issue 同步**：依 `.github/ISSUE_TEMPLATE/sdd.md` 建立或更新 SDD Issue，並在對應 BDD Issue 的 Scenario 對照表回填契約資訊；提醒下一步交給 `tdd-requirements.prompt.md`。

### 交付給 TDD 的輸出清單
- 契約對照表（含 `BDD-###`、契約名稱、版本、驗證方式、對應 SDD Issue `#`）。
- Mock／樣本資料清單與準備狀態（🟡／🔴）。
- 版本與部署策略摘要（切換方式、回滾負責人、監控需求）。
- 需 TDD 補強的測試與環境前置作業。

## 產出要求

- 契約對照表需與 Scenario 對應清楚，避免遺漏；引用資料附 `#編號`，對待確認項目標註 🟡／🔴。
- Mock 與測試策略要有明確責任人或指派對象。
- 版本策略需列出版號（SemVer 或日期）、相容性評估、回滾責任人與需同步的 Issue `#編號`。
- 若需新增契約檔案，請指出預計存放路徑與命名。

## 後續建議

- 完成後先通知 `tdd-checkpoint.prompt.md` 更新進度，再依建議啟動 `tdd-requirements.prompt.md` 或其他 TDD 子流程。
- 若執行過程發現需求改動，回頭更新 BDD Issue 並註記差異。
- 在輸出結尾提醒使用者確認新建的 SDD Issue 與契約檔案位置。
- 所有 Issue 參考一律使用 `#編號`，對於推測或待確認的資訊標註 🟡／🔴；記得同步回填 BDD Issue 的 Scenario 對照表。

## Issue 操作提醒

依 `_issue-ops-guide.md` 的「SDD」指引建立或更新 Issue：貼上契約對照表、Mock / 樣本策略與版本規畫，更新 Scenario 對照表並同步通知 BDD / TDD Issue（互相引用，對待確認項目標註 🟡／🔴）。
- 若需新建 Issue，標題務必使用 `[SDD] 模組／契約名稱 - 簡述`，並將「模組／契約名稱」替換為實際名稱、保留後綴「- 簡述」。
