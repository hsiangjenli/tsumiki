---
mode: agent
description: 依照 SDD 契約設計模板，將 BDD 案例轉為具體介面與資料契約，並安排後續合約測試
inputs:
  summary: 需先取得 BDD Issue 與相關設計資料，確認要涵蓋的情境
  required:
    - 目標 BDD Issue 連結與 Scenario 摘要
    - 現有或需延用的契約文件（OpenAPI、Schema、模型說明等）
    - 涉及的子系統與資料流限制
    - Mock / 測試環境需求
    - 語言與輸出格式偏好（預設繁體中文 + Markdown）
outputs:
  summary: 產出符合 `.github/ISSUE_TEMPLATE/sdd.md` 的內容，並排定合約測試與 mock 待辦
  include:
    - 對每個 Gherkin 情境（以 `BDD-###` 標識）對應的契約類型、名稱、關鍵欄位與驗證方式
    - Mock／樣本資料策略與預期失敗案例
    - 版本與部署策略（相容性、切換、監控）
    - 對應的 TDD Issue 建議與開放問題
    - 提醒使用者透過 MCP 建立 SDD Issue、更新契約檔案位置
---

# sdd

## 目的

根據既有 BDD 案例，萃取所有需要更新或新增的介面、資料、模型與流程契約，確保後續實作有明確的合約測試與 mock 依據。

## 前置條件

- 已有 BDD Issue（或草稿）可參考。
- 確認需求未進一步變動，若有變動需先回到 BDD 更新。
- 可存取相關設計文件、既有契約或資料字典。

## 問答原則

- 每題提供最多 4 個選項，加上「⑤ 其他（自由輸入）」。
- 若情境跨多個子系統，分別詢問各子系統的需求與限制。
- 針對資料或模型契約，要確認來源、版控方式與隱私限制。

## 流程

### Phase 0：資料同步
1. **讀取 BDD 案例**：整理 Scenario 與對應需求編號／Scenario ID（`BDD-###`），標示信賴等級。
2. **盤點既有契約**：確認是否已有 OpenAPI、AsyncAPI、Schema、模型版本等可沿用資源。
3. **確認子系統範圍**：列出 API、事件流、資料表、UI、模型、排程、監控等範疇。

### Phase 1：契約訪談
1. **針對每個情境詢問契約需求**：輸入／輸出資料、欄位格式、驗證條件。
2. **資料與模型細節**：確認資料來源、清洗規則、特徵定義、模型版本策略。
3. **UI 或狀態契約**：若涉及 UI，確認元件狀態、互動限制、無障礙需求。
4. **部署與相容性**：詢問版本命名、切換計畫、影響的服務或管線。
5. **Mock 與測試環境**：蒐集所需工具、樣本資料、驗證腳本、預期失敗案例。

### Phase 2：整理輸出
1. **填寫契約對照表**：對每個 Gherkin 情境列出契約類型、名稱、關鍵欄位與驗證方式。
2. **描述 Mock / 測試策略**：包含執行方式、負責人、時間點、樣本位置。
3. **記錄版本與部署策略**：向後相容性、切換流程、監控與回滾方案。
4. **列出待辦與連結**：預計建立的 TDD Issue、需更新的文件、相關 PR。
5. **維護開放問題**：尚未決定的欄位、資料來源、法規限制等。
6. **建立 SDD Issue**：依 `.github/ISSUE_TEMPLATE/sdd.md` 組裝內容，透過 MCP 或人工方式開 Issue，並附上契約檔案路徑或附件資訊。

## 產出要求

- 契約對照表需與 Scenario 對應清楚，避免遺漏。
- Mock 與測試策略要有明確責任人或指派對象。
- 版本策略需涵蓋相容性與回滾簡述。
- 若需新增契約檔案，請指出預計存放路徑與命名。

## 後續建議

- 完成後馬上串接 `tdd.prompt.md`，將契約轉化為測試待辦。
- 若執行過程發現需求改動，回頭更新 BDD Issue 並註記差異。
- 在輸出結尾提醒使用者確認新建的 SDD Issue 與契約檔案位置。
