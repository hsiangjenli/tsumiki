---
mode: agent
description: 根據 TDD 需求與 BDD 情境篩選、撰寫測試案例，建立 Red 階段的待辦清單
inputs:
  summary: 以本 Prompt 蒐集並整理測試案例所需的條件與資料
  required:
    - 最新的 TDD Issue 背景（或 `tdd-requirements` 輸出）
    - 對應的 BDD Scenario 與 SDD 契約摘要
    - 可用的測試資料來源、Mock 或樣本檔
    - 既有測試框架與 CI/CD 限制
    - 語言與輸出格式偏好（預設繁體中文 + Markdown）
outputs:
  summary: 形成 `.github/ISSUE_TEMPLATE/tdd.md`「測試計畫」欄位的初稿
  include:
    - 測試項目清單（欄位固定為：`Test ID`、`Scenario ID (BDD-###)`、`需求 #`、`測試類型`、`資料/Mock`、`狀態`、`優先順序`、`備註`，引用既有資料附上 `#編號`，僅對尚未確認的資訊標註 🟡／🔴）
    - 必要的測試資料、環境與依賴說明（使用 `#編號` 或檔案路徑標示來源；對缺口標註 🟡／🔴）
    - 評估優先順序與 Red → Green → Refactor 預期路徑
    - 待補資料與轉交 `tdd-red.prompt.md` 的重點；若發現可能的需求差異，將其標註為 🔴 供後續決策
    - 提醒同步更新 TDD Issue 及相關 TODO（勾選對應欄位，引用資料附 `#編號`）
---

# tdd-testcases

## 目的

結合 BDD 情境與 SDD 契約，挑選並撰寫要在 Red 階段實作的測試案例，讓後續實作有清楚的測試矩陣與資料準備。

## 適用情境
- 已完成 `tdd-requirements`，需要將情境轉為具體測試項目。
- 既有測試矩陣需擴充或更新，確認 Red 階段要處理的範圍。
- 若已存在完整測試矩陣且無需變更，可視情況略過本 Prompt 直接進入 `tdd-red`。

## 流程

### Phase 0：準備（情境確認）
1. 快速重點複習 `tdd-requirements` 的輸出與 TDD Issue 的「來源與範圍」。
2. 列出需涵蓋的 Gherkin 情境與對應契約，引用既有資料附上 `#編號`，僅對尚未確認的情境標註 🟡／🔴。
3. 確認測試框架、格式（如 Vitest、Jest、Playwright、pytest 等）。

### Phase 1：執行（測試設計）
1. 針對每個情境詢問：測試類型（單元 / 元件 / 整合 / E2E）、預期驗證點、必要輸入輸出。
2. 盤點測試資料、Mock、外部服務依賴，並標示取得方式。
3. 釐清效能 / 資安 / 模型等特殊測試需求。
4. 為每個測試項目設定初始狀態（預期 Red）。

### Phase 2：記錄與交接（輸出整合）
1. 建立測試矩陣：欄位需包含 `Test ID`、`Scenario ID (BDD-###)`、`需求 #編號`、`測試類型`、`資料/Mock`、`狀態`（預設 Red）、`優先順序`、`備註`。
2. 梳理 Red → Green → Refactor 的實作順序與里程碑，必要時標記 `Blocked` 原因（資料缺、契約待定等）。
3. 列出待補的測試資料或環境設定，指派負責人或下一步。若出現下列情況，僅需在表格中標註原因與狀態（🟡／🔴），待 `tdd-checkpoint` 或 `tdd-verify` 做回圈判定：
   - 欄位、介面定義或合約版本不清楚 → 註記為「契約待補」，並附上 `#` 來源。
   - 合約完整但缺樣本資料、Mock 或測試環境 → 保持在本階段補齊並標註負責人。
   - 需求描述與 BDD / SDD 明顯矛盾 → 註記為「需求疑慮 🔴」，附來源，稍後決定是否回到 `requirements-change`。
4. 整理交接摘要：將優先測試項目、待補資料與阻塞整理成清單，供下一個子流程引用（必要時註明建議負責人與時程）。
5. 提醒更新 TDD Issue、TODO 或任務資料庫，並勾選 Issue「迭代進度」中的 `Testcases` 核取框。

## 產出格式建議

- **測試矩陣表格**：使用 `Test ID | Scenario ID (BDD-###) | 需求 # | 測試類型 | 資料/Mock | 狀態 | 優先順序 | 備註 | 來源/狀態` 欄位，可直接貼入 TDD Issue。範例：
  ```markdown
  | Test ID | Scenario ID (BDD-###) | 需求 # | 測試類型 | 資料/Mock | 狀態 | 優先順序 | 備註 | 來源/狀態 |
  | --- | --- | --- | --- | --- | --- | --- | --- | --- |
  | T-101 | BDD-001 | #123 | 單元 | mock/login-success.json | Red | P0 | 主要成功路徑 | #123 |
  | T-102 | BDD-002 | #123 | 整合 | staging user fixture | Red | P1 | OTP 逾時案例 | 使用者口頭說明 🔴 |
  ```
- **資料 / Mock 清單**：列出檔案位置、建立方式、責任人；引用既有資料附 `#編號`，對缺口標註 🟡／🔴。
- **依賴與風險**：列出外部服務、守門檢查、回滾策略與狀態。
- **後續動作**：明確寫出下一步應執行 `tdd-red.prompt.md`，並附上需攜帶的測試項目摘要。

## 後續建議

- Red 階段前，確認測試檔案與案例命名規則並啟動 `tdd-red.prompt.md`。
- 若測試案例有爭議，回到 BDD / SDD Issue 取得共識。
- 在輸出末尾提醒使用者或 AI 建立／更新 TDD Issue 的測試區塊，並於評論記錄資料缺口與下一步負責人。

## Issue 操作提醒

依 `_issue-ops-guide.md` 的「TDD」指引更新測試矩陣：貼上本次輸出、勾選 `Testcases` 核取框，並於評論註記資料缺口與責任人；如需額外待辦，建立新 Issue 後互相引用；若需新建 TDD Issue，標題務必使用 `[TDD] 模組／測試套件名稱 - 簡述`。
