---
mode: agent
description: 依據測試矩陣實作 Red 階段，撰寫會失敗的測試並記錄阻塞事項
inputs:
  summary: 以本 Prompt 產生 Red 階段的測試與紀錄
  required:
    - 目標 TDD Issue 編號與測試矩陣（含優先順序）
    - 對應的 BDD Scenario / SDD 契約重點
    - 測試框架與指令（例如 `pnpm test --filter ...`）
    - Mock、測試資料或外部依賴準備情況
    - 語言與輸出格式偏好（預設繁體中文 + Markdown）
outputs:
  summary: 建立失敗測試並更新 TDD Issue 的 Red 階段狀態
  include:
    - 新增或調整測試檔案的摘要（檔名、情境、預期失敗訊息）
    - 執行測試結果與錯誤截圖／重點輸出
    - 連續錯誤追蹤表（欄位：`Test ID`、`測試檔/名稱`、`錯誤摘要(前120字)`、`錯誤分類`、`連續次數`、`MCP 行動`）
    - 阻塞清單與後續處置（含需要回填 BDD/SDD 的項目）
    - 提醒連續 3 次相同錯誤需透過 MCP 在 TDD Issue 留言；若達 5 次，需透過 MCP 將標籤改為 `human_required` 並說明原因
    - 建議切換至 `tdd-green.prompt.md` 的條件
---

# tdd-red

## 目的

依照測試矩陣撰寫會失敗的測試，清楚記錄失敗原因、阻塞與需要補強的資料，為 Green 階段做準備。

## 流程

### Phase 0：任務對齊
1. 從 TDD Issue 取得本次要處理的測試項目與優先順序。
2. 確認測試框架與指令，必要時同步安裝或更新依賴。
3. 盤點已準備的 Mock / 資料，缺漏部分列入待辦。

### Phase 1：撰寫測試
1. 針對選定項目新增或調整測試檔案，確保描述符合 Gherkin 情境。
2. 測試應刻意失敗（Red），並在註解說明期待的行為。
3. 執行測試並收集錯誤訊息、堆疊、快照差異等資訊。
4. 若測試未失敗，分析原因（可能漏寫斷言 / 已有實作），記錄於輸出並重新調整。

### Phase 2：紀錄與交接
1. 將執行結果、失敗訊息、阻塞項目整理成段落或表格。
2. 若遇到資料或合約缺口，提醒回寫至 BDD / SDD Issue。
3. 為每個錯誤標記分類（建議：`Test Failure`、`Build/Setup Failure`、`External Dependency`），並累計重複次數。累計規則（以「測試識別子 + 錯誤摘要」判斷，同一測試檔案與測試名稱出現相同錯誤訊息前 120 字視為同一錯誤）：
   - 若同一錯誤連續 3 次出現，必須透過 MCP 在 TDD Issue 留言紀錄（描述錯誤、嘗試解法、下一步）。
   - 若同一錯誤連續 5 次出現，需透過 MCP 將 TDD Issue 標籤調整為 `human_required`，並在留言註明理由與已嘗試的步驟。
4. 提醒更新 TDD Issue 中測試矩陣的狀態（保持 Red）。
5. 建議下一步進行 `tdd-green.prompt.md`，並帶上此輪測試的重點與阻塞。

## 產出格式建議

- **測試摘要表**：檔案、情境、預期結果、實際錯誤。
- **阻塞清單**：需補的資料 / 契約 / 權限、負責人、預計完成時間。
- **Issue 留言建議**：若觸發 3 次同錯誤，附上留言範本。

## 後續建議

- 完成 Red 後，立即執行 `tdd-green.prompt.md` 進行實作。
- 若阻塞涉及跨團隊，於輸出末尾提醒建立後續 Issue 或請求支援。
- 定期將測試檔路徑與情境摘要同步到 TDD Issue。
