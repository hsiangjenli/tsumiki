---
mode: agent
description: 依據測試矩陣實作 Red 階段，撰寫會失敗的測試並記錄阻塞事項
inputs:
  summary: 以本 Prompt 產生 Red 階段的測試與紀錄
  required:
    - 目標 TDD Issue 編號與測試矩陣（含優先順序）
    - 對應的 BDD Scenario / SDD 契約重點
    - 測試框架與指令（例如 `pnpm test --filter ...`）
    - Mock、測試資料或外部依賴準備情況
    - 語言與輸出格式偏好（預設繁體中文 + Markdown）
outputs:
  summary: 建立失敗測試並更新 TDD Issue 的 Red 階段狀態
  include:
    - 新增或調整測試檔案的摘要（檔名、情境、預期失敗訊息）
    - 執行測試結果與錯誤截圖／重點輸出
    - 連續錯誤追蹤表（欄位：`Test ID`、`測試檔/名稱`、`錯誤摘要(前120字)`、`錯誤分類`、`連續次數`、`備註`、`來源/狀態`）
    - 阻塞清單與後續處置（含需要回填 BDD/SDD 的項目與對應 Issue `#編號`，對仍待確認的事項標註 🟡／🔴）
    - 連續錯誤達 3 次時的留言重點與 5 次時的標籤調整提醒（依 README 規範）
    - 建議切換至 `tdd-green.prompt.md` 的條件
---

# tdd-red

## 目的

依照測試矩陣撰寫會失敗的測試，清楚記錄失敗原因、阻塞與需要補強的資料，為 Green 階段做準備。

## 流程

### Step 1：定位測試
1. 從 TDD Issue 的測試矩陣選定此次要處理的 Test ID 與優先順序，確認對應 `BDD-###` 與契約重點。
2. 檢查測試框架與執行指令是否可用；需要的 Mock / 資料不足時記錄為待辦即可，不在此階段強行補齊。
3. 若情境看似與需求／契約矛盾，將該項標註為 🔴 並記錄依據，決策留待 `tdd-checkpoint` 或 `tdd-verify`。

### Step 2：撰寫 Red 測試
1. 依 Gherkin 情境新增或調整測試，讓它在現況下必然失敗，並用註解說明預期行為。
2. 執行測試並記錄錯誤訊息、堆疊、快照差異等重點輸出。
3. 若測試未失敗，記錄原因（斷言不足或已有實作），重新調整測試直到回到 Red；若確定是需求差異，保持 Red 並標註 🔴。

### Step 3：整理輸出
1. 彙整測試檔案、情境、預期結果與實際錯誤，形成可貼入 Issue 的摘要。
2. 若發現 Mock／資料／契約缺口，記錄於阻塞清單並指出需要同步的 BDD / SDD Issue。
3. 維護連續錯誤追蹤表，依 README〈MCP 錯誤處理〉規則記錄同一錯誤的次數（3 次留言、5 次改標籤）；僅提示行動，決策仍交給後續檢查點。
4. 更新 TDD Issue 測試矩陣狀態（維持 Red）與迭代核取框。
5. 指出下一步應執行 `tdd-green.prompt.md`，並列出 Green 階段需要注意的重點或阻塞。

## 產出格式建議

- **測試摘要表**：檔案、情境、預期結果、實際錯誤、來源／狀態（引用既有資料附 `#編號`，對疑慮標註 🟡／🔴）。
- **阻塞清單**：需補的資料 / 契約 / 權限、負責人、預計完成時間、對應 Issue `#編號`。
- **Issue 留言建議**：若觸發 3 次同錯誤，附上留言範本（必要欄位：錯誤摘要、嘗試步驟、來源 `#編號`、目前狀態、下一步）。

## 後續建議

- 完成 Red 後，立即執行 `tdd-green.prompt.md` 進行實作。
- 若阻塞涉及跨團隊，於輸出末尾提醒建立後續 Issue 或請求支援。
- 定期將測試檔路徑與情境摘要同步到 TDD Issue，並標註來源或狀態（🟡／🔴）。

## Issue 操作提醒

依 `_issue-ops-guide.md` 的「TDD」指引：更新測試矩陣維持 Red 狀態、記錄錯誤摘要與連續次數，必要時於評論留下 MCP 留言重點；若另建待辦，請互相引用；若需新建 TDD Issue，標題務必使用 `[TDD] 模組／測試套件名稱 - 簡述`。
