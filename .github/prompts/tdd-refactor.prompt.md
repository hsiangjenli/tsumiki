---
mode: agent
description: 在測試保持綠燈的狀態下重構程式並更新文件，確保品質與可維護性
inputs:
  summary: 本 Prompt 指導 Refactor 階段的重構與驗證
  required:
    - 目標 TDD Issue 與最新測試矩陣（已轉綠的項目）
    - Green 階段的變更摘要與待辦事項
    - 相關程式碼路徑、設計規範、程式碼規約
    - 需同步調整的文件或契約
    - 語言與輸出格式偏好（預設繁體中文 + Markdown）
outputs:
  summary: 描述重構內容、額外品質檢查與後續待辦，保持測試綠燈
  include:
    - 重構步驟、改善項目與驗證證據（測試 / 分析報告），引用資料附 `#編號`，對待確認項目標註 🟡／🔴
    - 受影響的文件或契約更新摘要（列出路徑與 Issue `#編號`）
    - 品質檢查結果（至少覆蓋：Lint、型別檢查、單元/整合測試、Coverage、依賴/資安掃描、建置時間、靜態分析）
    - 待處理的技術債與風險因應（含優先順序與責任人）
    - 建議切換至 `tdd-verify.prompt.md` 或重新進入 Red 的條件
---

# tdd-refactor

## 目的

在維持所有測試綠燈的前提下，整理 Green 階段產生的程式碼，提升結構、命名與可維護性，並同步更新相關文件或契約。

## 流程

### Step 1：確認基線
1. 複查所有相關測試為綠燈並留存證據（命令、CI 連結）。若失敗請先回到 `tdd-green`。
2. 彙整 Green 階段留下的待辦、技術債或需改寫的區塊，以 Must/Should/Could 排序。
3. 確認適用的設計規約與碼規，決定此次要運行的品質檢查（建議至少：Lint、型別、Coverage、依賴/資安掃描）。

### Step 2：執行重構
1. 逐項處理優先度最高的重構，說明目的與受影響檔案；引用資料附 `#編號`，對未確認假設標註 🟡／🔴。
2. 每次重構後立即重跑測試與選定的品質檢查，確保維持綠燈並記錄結果。
3. 若需同步調整契約或文件，記錄路徑與對應情境（Issue `#編號`）。

### Step 3：整理成果
1. 彙整重構內容、測試輸出、品質檢查結果（Lint、型別、Coverage、資安／依賴、靜態分析或建置時間）。
2. 更新 TDD Issue 測試矩陣備註與 `Refactor` 核取框，附上驗證證據連結。
3. 列出尚未處理的技術債，提供建議優先順序、責任人與時程；必要時建議建立後續 Issue。
4. 說明是否已達成進入 `tdd-verify.prompt.md` 的條件；若品質檢查仍有紅燈，提示需回到 `tdd-green` 或 `requirements-change`。

## 產出格式建議

- **重構摘要表**：檔案、改善內容、理由、驗證方式、來源／狀態。
- **文件更新列表**：同步修改的契約、文件、README 等，附 `#編號` 或路徑。
- **品質檢查表**：列出 Lint、型別、測試 (含 coverage)、資安掃描、依賴更新、建置時間、靜態分析的結果與證據。
- **技術債追蹤**：列出需後續處理的項目與建議時程、責任人。

## 後續建議

- 若重構導致測試失敗，需立即回到 `tdd-red.prompt.md` 或 `tdd-green.prompt.md` 修正。
- 完成後執行 `tdd-verify.prompt.md`，確認整體品質無回歸。
- 在輸出末尾提醒使用者更新 TDD Issue 狀態，並標註是否需要開後續 Issue（附來源或狀態）。

## Issue 操作提醒

依 `_issue-ops-guide.md` 的「TDD」指引：更新測試矩陣備註、記錄品質檢查結果並勾選 `Refactor` 核取框；若需建立技術債或文件更新 Issue，請互相引用。
