---
mode: agent
description: 蒐集並確認需求後，以 EARS 與 GWT 為核心，串接 BDD→SDD→TDD 循環產生正式需求輸出
inputs:
  summary: 先釐清需求來源與限制再執行本 Prompt
  required:
    - 使用者提供的需求概要與最終目標（對話、文件或 Issue）
    - 目前可用的專案文件清單與路徑（例如 docs/spec/, README.md, CLAUDE.md）
    - 相關 GitHub Issue 編號與重點留言、必要的 changelog 摘要
    - 語言與輸出格式偏好（預設繁體中文 + Markdown）
    - 必須遵循的時程、技術或 CI/CD 限制
outputs:
  summary: 形成可追蹤的需求定義並安排後續動作
  include:
    - EARS 記法整理的功能需求（附信賴等級與來源）
    - BDD（Gherkin）案例、SDD 契約更新、TDD 測試計畫
    - 任務幅度與涉及子系統（前端／後端／AI／資料處理等）的界線說明
    - 建議建立或更新的 GitHub Issue（標題、標籤、重點）
    - 推薦下一個 Prompt 與待確認事項，並提醒將輸出留存於 GitHub Issue（可由 MCP 直接建立）
---

# requirements

## 目的

以 EARS 記法整理需求並補齊 GWT 驗收描述，同時對齊 BDD → SDD → TDD 的實作循環。適用於 API、前／後端、資料處理、AI/ML、排程、資料庫與混合型任務，協助快速掌握任務幅度與跨子系統的影響。

## 提問原則

- 採「單一問題 + 選項 + 自訂輸入」格式，便於使用者快速回覆。
- 每題最多 4 個選項，預留「⑤ 其他／自行輸入」。
- 必要時加入範例或預設值（例如：「預設語言：繁體中文」）。
- 優先確認是否已有對應 GitHub Issue／模板；若無，詢問是否需要建立。

**問題範例**
```
目前主要聚焦的領域是？
① API / 後端服務
② 前端或 UI 互動
③ 資料處理 / ETL / ML 訓練
④ 排程 / Lambda / 基礎設施
⑤ 其他（請說明）
```

## 操作流程

在任何階段都需為資訊標記信賴等級：🔵（直接引用）、🟡（合理推測）、🔴（尚待確認）。

### Phase 0：盤點現況（Discovery）

**目標**：掌握既有資產、任務幅度與限制條件。

1. **掌握上下文**：讀取 `CLAUDE.md`、`AGENTS.md`、`README.md`、`CHANGELOG.md` 或同等文件，列出近期變更。
2. **收斂規範**：檢視 `docs/rule/`、`docs/rule/kairo/requirements/` 或其他專案規範。
3. **資產清查**：使用 `rg --files` 盤點 `docs/spec/`、`docs/design/`、`commands/`、`notebooks/` 等，標示曾產出的規格、模型、流程圖。
4. **GitHub 連結**：透過 MCP 取得相關 Issue／PR，整理標題、狀態、指派人。
5. **任務幅度矩陣**：紀錄涉及的子系統（✅ 或 ☐）：API、前端、資料管線、模型訓練／推論、排程／Lambda、資料庫／倉儲、基礎設施／觀測、其他。
6. **約束條件**：確認時程、預算、技術棧、CI/CD、法規、資料治理等限制。

若任何項目資料不足，直接提出多選問題要求補充。

### Phase 1：需求訪談（Interview）

**目標**：釐清缺口、範圍與優先順序。

1. **定位情境**：根據 Phase 0 的矩陣，先確認本次焦點（API / 前端 / Data / AI / Infra 等），使用選項題請使用者選擇，可複選。
2. **EARS 缺口盤點**：以表格列出「已知需求／缺口／信賴等級」，逐項詢問：
   - 「此功能是否已有確認來源？」（選項：① 已確認、② 推測、③ 未提及、④ 移除、⑤ 其他）
3. **GWT 情境補強**：針對尚未覆蓋的 Gherkin 場景，詢問觸發條件、關鍵指標與成功／失敗訊號。
4. **非功能／跨領域議題**：對效能、安全、成本、資料品質、模型評估、可維運性等提出選項題確認。
5. **範圍與優先順序**：使用 MoSCoW 選項題或時間盒問題確認 Must/Should/Could/Won't 以及目標里程碑。

所有訪談輸入需即時轉記錄（含信賴等級），避免遺漏。

### Phase 2：對齊 BDD → SDD → TDD（Alignment）

**目標**：把人話需求對應到可執行的測試、契約與實作計畫。

1. **BDD（行為驅動）**
   - 依主題整理使用者故事（WHO/WHAT/WHY），並為每個故事建立 Gherkin 範例。
   - 若涵蓋多子系統，將案例分組（例如：API 呼叫、前端互動、批次流程、模型推論、監控警示）。
   - 標示每個案例的信賴等級，未定義者列入開放問題。
2. **SDD（規格驅動）**
   - 從 BDD 案例萃取介面或資料契約：OpenAPI／AsyncAPI／GraphQL／gRPC、事件 schema、資料表／檔案格式、特徵與模型版本、UI 元件協定、排程設定、監控 KPI。
   - 為每項契約明確指定：版本策略、mock／樣本檔、合約測試或資料驗證方式。
   - 若屬「資料／契約優先」工作，可先定義 SDD，但需補回對應的 BDD 案例。
3. **TDD（測試驅動）**
   - 建立單元／元件／資料處理／模型驗證測試清單，標示 Red → Green → Refactor 步驟。
   - 確認測試所需環境（container、雲資源、GPU、排程器）、資料集與守護性檢查（schema 驗證、模型 drift、資安掃描）。
   - 為每個測試對應的 BDD 案例與 SDD 契約建立映射表。
4. **Issue 輸出與同步**
   - 優先採用 `.github/ISSUE_TEMPLATE/` 下的模板（例如 `userstory`, `spec`, `tdd`, `gwt`, `datascience`, `frontend`）。
   - 若無合適模板，使用暫用格式（標題、任務幅度、EARS、Gherkin、契約需求、TDD 計畫、信賴等級、下一步），並在輸出中建議新增正式模板。
   - 透過 MCP 建立或更新 Issue，附上檔案連結、mock、資料樣本或模型位置。
5. **本地補充（選擇性）**
   - 若使用者要求保留於 `docs/spec/` 等路徑，可同步更新並標註此次變更，但以 GitHub Issue 為追蹤主體。

## 產出清單

- 需求摘要：任務幅度、EARS 條列、信賴等級、待決議題。
- BDD：Gherkin 案例清單、對應子系統與 Issue 連結。
- SDD：介面／資料／模型／UI／排程等契約需求、預計採用的規格與驗證策略。
- TDD：測試待辦與環境需求、Red → Green → Refactor 規劃、風險與守護性檢查。
- 後續指令建議：例如 `design.prompt.md`、`requirements-change.prompt.md` 或任務拆解流程。
- GitHub Issue 更新：提醒由 AI（透過 MCP）或使用者將輸出附加於相關 Issue，以利追蹤。

## 後續行動

- 依產出清單建立或更新 GitHub Issue，確認指派與時程。
- 若進入設計或實作階段，建議切換至 `design.prompt.md`、任務拆解或實作模板。
- 維護訪談紀錄、信賴等級、任務幅度矩陣，以便日後需求變更時快速回溯。
