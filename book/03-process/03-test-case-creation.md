# 3.3 撰寫測試案例

## 為什麼測試案例這麼重要

在 AITDD 中，測試案例是決定最終品質的關鍵。AI 產出的程式碼品質，取決於測試案例是否全面且精準，因此這個階段務必花時間做好規劃。

## 設計測試案例的原則

### 1. 確保完整性

#### 功能涵蓋
- **正常流程**：所有預期動作
- **異常流程**：錯誤處理與驗證
- **邊界值**：輸入極限條件
- **特殊情境**：罕見或例外狀況

#### 測試層級
- **單元測試**：函式／方法層級
- **整合測試**：模組間互動
- **端到端測試**：完整使用者路徑

### 2. 給出明確期待結果
```markdown
❌ 「應該發生錯誤」
✅ 「回傳 400，訊息為 "Email already exists"」
```

### 3. 保持獨立與可重現
- 每個測試案例能獨立執行
- 不依賴執行順序
- 不依賴特殊外部環境

## 標準化的測試文件格式

### 範本
```markdown
# [功能名稱] 測試案例規格

## 概要
- **功能**：...
- **目的**：...
- **前置條件**：...

## 測試案例

### TC001：案例名稱
- **分類**：正常／異常／邊界
- **目的**：驗證重點
- **前置條件**：...
- **測試資料**：...
- **步驟**：
  1. ...
  2. ...
- **期待結果**：
  - ...
- **後置狀態**：...
```

### 範例：使用者註冊
```markdown
# 使用者註冊 測試案例

## 概要
- **功能**：POST /api/users
- **目的**：驗證各種註冊情境
- **前置條件**：資料庫為初始狀態

## 測試案例

### TC001：正常註冊
- **分類**：正常
- **目的**：有效資料應成功註冊
- **前置條件**：test@example.com 未被使用
- **資料**：
  ```json
  {
    "email": "test@example.com",
    "password": "SecurePass123!",
    "password_confirmation": "SecurePass123!"
  }
  ```
- **步驟**：
  1. 發送 POST /api/users
  2. 檢查回應
  3. 檢查資料庫
- **期待結果**：
  - HTTP 201
  - 回傳 ID、email、建立時間
  - 資料庫新增一筆、密碼為雜湊值
- **後置狀態**：可登入

### TC002：Email 重複
- **分類**：異常
- **資料**：...
- **期待結果**：HTTP 400 + 詳細錯誤

### TC003：密碼確認不一致
- **分類**：異常
- **期待結果**：HTTP 400，訊息「Password confirmation does not match」

### TC004：Email 格式錯誤
- **分類**：異常／邊界
- **資料**：多種非法格式
- **期待結果**：全部為 400

### TC005：密碼強度不足
- **分類**：異常／邊界
- **資料**：長度、大小寫、符號等不足
- **期待結果**：全部為 400

### TC006：必填欄位缺失
- **分類**：異常
- **資料**：省略 email／password 等
- **期待結果**：全部為 400

### TC007：Email 長度邊界
- **分類**：邊界值
- **資料**：254 與 255 字
- **期待結果**：254 成功、255 失敗

### TC008：流量限制
- **分類**：非功能
- **目的**：檢查 Rate Limit
- **期待結果**：超過限制回傳 429

### TC009：資料庫錯誤
- **分類**：異常／基礎設施
- **目的**：資料庫不可用時回應 500 並記錄

### TC010：CSRF 驗證
- **分類**：安全性
- **目的**：無 Token 時回傳 403
```

## 撰寫測試案例的流程

### 1. 從規格抽取案例
```markdown
規格 → 對應測試
- 基本功能 → 正常案例
- 驗證規則 → 異常與邊界
- 非功能需求 → 效能／安全案例
```

### 2. 設計步驟
1. 列出所有測試觀點
2. 建立測試矩陣
3. 將每格內容展開成詳細案例

### 3. 善用 AI 的部分
- 漏洞檢查
- 生成測試資料
- 協助計算期待值
- 整理格式

### 4. 必須由人決定的部分
- 業務需求解讀
- 風險評估
- 優先順序
- 驗收標準

## 評估測試案例品質

### 1. 完整性
- API、參數、回應是否全面
- 錯誤處理是否涵蓋
- 商務流程是否涵蓋

### 2. 可執行性
- 測試資料是否可準備
- 是否能客觀驗證結果
- 自動／手動測試安排清楚

### 3. 易於維護
- 測試獨立、不互相影響
- 修改規格時易於調整
- 測試資料易於管理

## 審查重點

### 檢視方向
1. **商務一致性**：用戶故事、流程是否涵蓋
2. **風險優先**：高風險功能是否加強測試
3. **效率考量**：避免過度重複，自動與手動配比合理

### 審查流程
1. 初步審查：確認與規格一致
2. 詳細審查：逐案檢視期待結果、可執行性
3. 最終核准：檢查整體品質與測試計畫

## 最佳實務

1. **逐步細化**  
   概要 → 功能 → 詳細案例

2. **策略性規劃測試資料**  
   正常／邊界／異常／特殊資料分層保存

3. **具體描述期待結果**  
   明確寫出狀態碼、回應內容、DB 狀態

## 常見問題與對策

1. 顆粒度不當 → 一個案例只驗證一件事
2. 期待結果模糊 → 用具體值描述
3. 遺漏情境 → 透過清單檢查
4. 難以維護 → 模組化設計、共用資料

## 下一步

完成測試案例後，請進入 [Red-Green-Refactor-Validation 循環](./04-rgr-validation-cycle.md)。

### 自我檢查
- [ ] `testcases.md` 已完成
- [ ] 規格每項都有對應測試
- [ ] 期待結果明確
- [ ] 已通過人工審查
- [ ] 測試資料準備就緒

### 品質檢核
- [ ] 有涵蓋正常／異常／邊界情境
- [ ] 期待結果具體且可驗證
- [ ] 測試彼此獨立
- [ ] 可在環境中執行
- [ ] 容易調整維護

當測試案例準備完善，AI 才有足夠資訊產出高品質程式碼。接著，我們將進入實作循環並深入了解每個步驟。
