# 2.2 善用 Claude Sonnet 4

本章說明 AITDD 核心工具「Claude Sonnet 4」的最佳使用方式。重點不只在於讓 AI 寫程式，而是學會如何與 AI 協作，打造高品質的軟體。

## Claude Sonnet 4 的定位與優勢

### 在 AITDD 流程中的角色
- **執行 Red-Green-Refactor-Validation 循環的主力**
- **從設計、測試到實作皆可一手包辦**
- **兼具程式生成與品質檢核能力**

### 選擇它的理由
- **易於取得**：可透過 Claude Code 自由使用
- **穩定的程式實力**：足以滿足多數實務需求
- **成本可控**：每月 20 美元即可使用
- **適配 AITDD**：非常適合反覆試驗的開發流程
- **整合性佳**：能與 VS Code 等環境順暢連動

## Claude Code 的基本操作

### 起動與連線
1. **啟動 Claude Code**  
   可在 VS Code 內開啟，或透過瀏覽器版 Claude 連線

2. **連結專案**  
   - 指定專案目錄
   - 掃描並理解檔案結構
   - 解析既有程式碼

### AITDD 常見對話範例

#### 1. 目標設定
```
你：「想實作使用者管理的 CRUD 功能，請先列出 TODO。」

Claude：「以下是 TODO：
1. 定義 User 模型
2. 撰寫使用者建立的測試案例
3. 實作使用者建立功能
...」
```

#### 2. 撰寫測試
```
你：「請為第一個 TODO 建立測試案例。」

Claude：「使用者模型測試如下：
```javascript
describe('User Model', () => {
  test('should create user with valid data', () => {
    // 測試內容
  });
});
```」
```

#### 3. 實作功能
```
你：「請撰寫通過上述測試的程式碼。」

Claude：「以下是對應的 User 模型：
```javascript
class User {
  constructor(name, email) {
    // 實作內容
  }
}
```」
```

## 撰寫高品質提示（Prompt）的原則

### 基本原則

#### 1. 明確的目標
**良好示範：**
```
「想實作 POST /users 的使用者註冊 API：
- 需要表單驗證
- 包含錯誤處理
- 希望先寫測試」
```

**不佳示範：**
```
「請做一個使用者功能」
```

#### 2. 提供完整背景
```
「專案資訊：
- 使用 Express.js + MongoDB
- 測試框架為 Jest
- 已有既定的 User 模型

新增需求：
- 實作使用者的個人資料更新 API」
```

#### 3. 明示限制條件
```
「限制條件：
- 維持既有 API 相容性
- 考慮資安需求
- 效能需在 1 秒內回應」
```

### 迭代調整提示的流程

1. **首次嘗試**：撰寫提示 → 執行 → 評估
2. **檢討調整**：找出落差 → 分析問題 → 改寫提示
3. **再次執行**：使用改良提示 → 檢查結果 → 視情況重複

### 實用提示模板

#### 功能實作模板
```
【實作請求】
功能：...
技術堆疊：...
需求：
- ...
- ...
- ...

限制：
- ...
- ...

預期產出：
- 測試案例
- 實作程式碼
- 必要文件
```

#### 除錯模板
```
【除錯請求】
問題描述：...
錯誤訊息：...
重現步驟：
1. ...
2. ...
3. ...

相關程式碼：...
預期行為：...
```

## 品質把關與人工審查

### 審查要點
1. **需求是否完整實現**
2. **測試是否涵蓋所有情境**
3. **限制條件是否遵守**

### 審查順序建議
1. 規格文件
2. 測試案例
3. 程式碼

### 審查清單
- [ ] 功能需求達成
- [ ] 錯誤處理合宜
- [ ] 資安要求符合
- [ ] 效能門檻符合
- [ ] 測試覆蓋充分
- [ ] 程式可讀、易維護

## 當 AI 輸出不理想時的策略

### 標準回復流程
1. **git reset** 還原狀態
2. **調整提示**，使需求更具體
3. **同一工具重新嘗試**
4. **確認結果是否改善**

### 何時使用 git reset
- 與預期差距太大
- 重寫程式比修改更快
- 多次修正仍無改善

### 調整提示的技巧
**提高明確度：**
```
# 修改前
「請修正這段程式」

# 修改後
「請修正以下問題：
1. 驗證錯誤未妥善處理
2. 回傳型別與規格不符
3. 缺少邊界情境測試」
```

**補充背景：**
```
# 修改前
「做一個 API」

# 修改後
「以 Express.js 建立 POST /api/users API：
- 輸入／輸出格式為 JSON
- 使用既有 User 模型
- MongoDB Atlas 已設定完成」
```

## 累積經驗：記錄成功與失敗

### 紀錄成功案例
```markdown
## 成功案例
日期：2025-06-21
任務：使用者認證 API
提示：...(詳述)
結果：一次到位、測試全過
心得：指定函式庫與資安需求可提升成功率
```

### 分析失敗案例
```markdown
## 改善紀錄
日期：2025-06-21
任務：複雜查詢最佳化
問題：多次嘗試仍未達效能要求
解法：git reset → 補充數據門檻 → 提供參考範例
心得：效能需以量化指標呈現，複雜任務要拆段
```

## 搭配其他 AI 工具的策略

### Gemini 作為調查助手
- 適合查詢新函式庫、閱讀長篇技術文件
- 能處理長上下文、整合多來源資訊
- 最終結果再提供給 Claude Sonnet 4 實作

### 區分兩者的使用情境

| 場景 | 建議工具 |
|------|-----------|
| 功能實作／測試／除錯 | Claude Sonnet 4 |
| 技術研究、大量閱讀 | Gemini |

### 連動範例
```
Gemini：調查 Next.js 14 的新功能與遷移步驟
↓
Claude Sonnet 4：依調查結果列出 TODO，並以 AITDD 實作首個功能
```

## 進階提示技巧

### 維持上下文
```
「請記住：
- 技術堆疊為 Express.js + MongoDB + Jest
- 已有使用者身分驗證
- 目標新增使用者個人資料管理
」
（後續可直接引用此背景）
```

### 漸進加深細節
```
1. 先請 AI 規畫整體架構
2. 再針對單一功能索取詳細規格
3. 最後要求撰寫測試與程式碼
```

## 失敗案例解析

### 例：缺乏具體資訊
```
失敗提示：「做一個 API」
成功提示：「請用 Express.js 建立 POST /api/users/profile ...」
```

### 例：未說明技術限制
```
失敗提示：「寫資料庫操作」→ AI 改用陌生 ORM
成功提示：「請用 Mongoose 7.x、既有 User 模型 ...」
```

### 調整提示檢核表
- [ ] 已說明技術堆疊
- [ ] 清楚描述輸入／輸出
- [ ] 指明錯誤處理方式
- [ ] 確保與既有程式相容
- [ ] 列出效能門檻
- [ ] 提醒資安要點

## 建立提示範本與改進紀錄

### 成功範本
```markdown
## API 實作提示範本
範本內容...
適用情境...
成功案例...
```

### 失敗案例紀錄
```markdown
## 改善紀錄
原提示...
遇到問題...
修正後的提示...
關鍵學習...
```

## 為何聚焦單一工具

1. **保持流程一致**：習慣一套工具即可逐步優化
2. **累積經驗值**：提示技巧、錯誤模式逐漸熟悉
3. **成本控管容易**：集中管理費用與使用量
4. **備援策略單純**：不用花腦筋選擇要切換哪個工具

| 指標 | 單一工具 | 多工具混用 |
|------|----------|-------------|
| 學習成本 | 低 | 高 |
| 提示優化效率 | 高 | 低 |
| 成本管理 | 簡單 | 複雜 |
| 問題回復 | 直接 | 繁瑣 |
| 知識累積 | 集中 | 分散 |

## 面對新工具的評估流程

1. 持續關注市場資訊與社群回饋
2. 資訊累積 3～6 個月後，選擇小專案試驗
3. 與現有流程做定量比較（效能、成本、整合度等）
4. 只有在優勢明顯時才評估遷移

**量化評估範例：**
- 性能提升 ≥ 20%
- 成本降低 ≥ 15%
- 學習成本 ≤ 2 週
- 整合成本 ≤ 既有工具的 50%

## 下一步

在掌握 Claude Sonnet 4 的用法後，請繼續閱讀〈2.3 建立開發環境與工作流程〉，打造完整的 AITDD 工作框架（含 TODO 管理與 Git 流程）。
