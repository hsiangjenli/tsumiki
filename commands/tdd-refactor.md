---
description: 執行 TDD 的 Refactor 階段。在測試通過後進行程式碼品質改善與重構。
---

# TDD Refactor 階段（程式碼改善）

執行 TDD 的 Refactor 階段。

## 前置準備

請先整理開發脈絡：

1. **讀取追加規範**
   - 若存在 `AGENTS.md` 檔案，請讀取
   - 若存在 `docs/rule` 目錄，請讀取
   - 若存在 `docs/rule/tdd` 目錄，請讀取  
   - 若存在 `docs/rule/tdd/refactor` 目錄，請讀取
   - 讀取各目錄內所有檔案並作為追加規範套用

2. **使用 @agent-symbol-searcher 搜尋重構相關資訊並讀取**
   - 搜尋既有程式碼風格與最佳實務，讀取樣式指南
   - 確認專案整體架構模式，讀取設計文件
   - 找出可重複使用的工具函式或元件，讀取相關檔案

3. **直接讀取相關檔案**
   - `docs/implements/{要件名}/{{task_id}}/{feature_name}-memo.md`：確認既有開發紀錄
   - `docs/implements/{要件名}/{{task_id}}/{feature_name}-requirements.md`：確認需求定義
   - `docs/implements/{要件名}/{{task_id}}/{feature_name}-testcases.md`：確認測試案例
   - `docs/implements/{要件名}/{{task_id}}/{feature_name}-green-phase.md`：確認 Green 階段實作
   - 視需要讀取相關設計文件與任務檔案

完成讀取後，依據已準備的脈絡資訊開始 Refactor 階段（程式碼改善）。

## 信賴等級指引

進行重構時，請對每項改善內容標示與原始資料的對照狀態：

- 🔵 **藍燈**：完全依據原始資料，幾乎無推測
- 🟡 **黃燈**：根據原始資料合理推測
- 🔴 **紅燈**：無對應資料，需自行推測

## 目標

在 **維持測試全數通過** 的前提下，針對 Green 階段的程式碼進行下列改善。

## 改善面向

### 1. 可讀性

- 改善變數與函式命名
- 充實繁體中文註解
- 優化程式結構

### 2. 消除重複（DRY）

- 整合重複流程
- 抽出常數
- 建立輔助函式

### 3. 設計品質

- 應用單一職責原則
- 梳理相依關係
- 檢討模組化邊界

- NEVER: 不得在實作程式碼撰寫 mock/stub
- NEVER: 不得以記憶體儲存取代資料庫實作

### 4. 檔案大小最佳化

- 儘量維持每個檔案少於 500 行
- 拆分過於龐大的檔案
- 設定合理模組界線

### 5. 程式碼品質

- 排除 lint 錯誤
- 排除 typecheck 錯誤
- 統一格式
- 通過靜態分析

### 6. 安全性檢查

- 找出並修正潛在脆弱點
- 加強輸入檢查
- 確認 SQL Injection 防護
- 確認 XSS 防護
- 確認 CSRF 防護
- 避免資料外洩
- 確認認證與授權邏輯

### 7. 效能檢查

- 分析演算法複雜度
- 優化記憶體使用
- 移除多餘處理
- 規畫快取策略
- 最佳化資料庫查詢
- 提升迴圈效率
- 正確實作非同步流程

### 8. 錯誤處理

- 強化輸入驗證
- 提供明確錯誤訊息
- 改善例外處理流程

## 重構註解要求

請改善既有註解並新增必要註解。

### 改善後的函式／方法註解

```javascript
/**
 * 【功能概要】：重構後的功能說明
 * 【改善內容】：此次重構做了哪些調整
 * 【設計方針】：採用此設計的理由
 * 【效能考量】：是否有性能改善與影響
 * 【維護性】：對維護性的提升
 * 🔵🟡🔴 信賴等級：註記資料依據
 * @param {type} paramName - 參數說明與限制
 * @returns {type} - 回傳值說明與保證
 */
function improvedFunction(paramName) {
  // 【實作細節】：重構後的實作內容與理由
}
```

### 輔助函式／工具函式

```javascript
/**
 * 【輔助函式】：說明此函式的角色與建立原因
 * 【可重複使用情境】：描述可套用的情境
 * 【單一職責】：界定此函式負責的範圍
 */
function helperFunction(input) {
  // 【效率改善】：說明如何提升效率 🔵🟡🔴
  // 【可讀性提升】：說明如何提升可讀性 🔵🟡🔴
}
```

### 常數與設定值

```javascript
// 【設定常數】：說明此常數的角色與設定理由 🔵🟡🔴
// 【可調整性】：說明未來可調整的方式與限制 🔵🟡🔴
const IMPROVED_CONSTANT = 100; // 【優化結果】：根據效能測試調整 🔵🟡🔴

// 【設定物件】：集中管理設定的原因
const CONFIG = {
  // 【各設定項目】：說明每個設定值的意義與影響
  maxRetries: 3, // 【重試次數】：依實務經驗設定
  timeout: 5000, // 【逾時時間】：兼顧體驗與安全
};
```

### 錯誤處理改善

```javascript
try {
  // 【處理開始】：描述此處要執行的作業
  executeProcess();
} catch (error) {
  // 【例外處理】：說明捕捉例外的原因與策略 🔵🟡🔴
  logError(error);
  // 【通知／補償策略】：說明後續是否重試、回報或補償 🔵🟡🔴
}
```

### return 語句

```javascript
function buildResponse(data) {
  // 【資料整理】：說明回傳前的整理流程
  const normalized = normalize(data);

  // 【回傳結構】：描述回傳結構的理由
  return {
    normalized,
    count: normalized.length,
    hasError: normalized.some((item) => item.error),
  };
}
```

## 重構步驟

1. **重新檢視需求與測試**
   - 確認目前實作是否仍符合需求
   - 檢查測試案例是否完整覆蓋

2. **檢查程式碼品質**
   - 目視檢查命名、結構、註解
   - 使用 lint、typecheck、格式化工具

3. **規畫改善項目**
   - 列出需要重構的區塊與原因
   - 評估對測試的影響

4. **逐步重構並隨時執行測試**
   - 每完成一項改善即執行測試
   - 保持測試全數通過

5. **記錄重構結果**
   - 在 memo 中描述改善項目
   - 記錄信賴等級與需人工覆盤的部分

## 測試與紀錄

- 每次修改後皆須執行測試
- 若測試失敗，記錄原因並調整
- 必要時更新需求文件或測試案例

## 輸出

- 更新的程式碼
- `docs/implements/{要件名}/{{task_id}}/{feature_name}-refactor-phase.md`
  - 重構摘要與目的
  - 改善前後差異
  - 測試結果與信賴等級

## 下一步

完成 Refactor 後，進入 `/tdd-verify-complete` 確認測試是否完整且結果符合預期。
